(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{1284:function(t,e,r){"use strict";r.r(e);var s=r(15),a=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"数据无序的原因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据无序的原因"}},[t._v("#")]),t._v(" 数据无序的原因")]),t._v(" "),s("p",[t._v("在多分区，多消费者，无法实现数据有序，当然也可以在consumer做缓存并在下游进行手动排序，但实现复杂，可靠性不高；而在单分区可以实现有序")]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:r(780)}}),t._v(" "),s("h2",{attrs:{id:"单分区有序的原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#单分区有序的原理"}},[t._v("#")]),t._v(" 单分区有序的原理")]),t._v(" "),s("blockquote",[s("p",[t._v("单分区内才能实现有序")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:r(568)}}),t._v(" "),s("p",[t._v("在Producer client 每个partition的NetworkClient缓存中，缓存了5个request进行发送，只有5个request都发送成功，才会进行下一个batch的发送")]),t._v(" "),s("p",[t._v("在kafka 1.x版本之前要保证数据单分区有序，需要设置如下条件")]),t._v(" "),s("ul",[s("li",[t._v("max.in.flight.requests.per.connection = 1 （不需要考虑是否开启幂等性）")])]),t._v(" "),s("p",[t._v("在kafka 1.x 版本保证数据单分区有序，条件如下")]),t._v(" "),s("ul",[s("li",[t._v("没有开启幂等性，需要设置 max.in.flight.requests.per.connection = 1")]),t._v(" "),s("li",[t._v("开启了幂等性，需要设置 max.in.flight.requests.per.connection <= 5\n"),s("ul",[s("li",[t._v("在kafka1.x以后，启用幂等性，kafka服务端会缓存producer发送的最近5个request的元数据，始终会保证最近的5个request是有序的")])])])]),t._v(" "),s("p",[s("img",{attrs:{src:r(781),alt:""}}),t._v("kafka集群在收到了request之后，如果是顺序收到的，则进行落盘，如果非顺序的，则会将当前收到的request缓存起来，等待下一个request判断顺序，如果是顺序的则落盘，否则存储在内存中，最多存储5个request；客户端Producer会将5个发送完成之后再进行下一个batch的request发送（如果request发送失败会不断重试)，因此保证了每个批次的request有序，从而保证整个partition内的消息有序")]),t._v(" "),s("p",[t._v("request的顺序是判断的依据是？")]),t._v(" "),s("ul",[s("li",[t._v("开启幂等性后，每个request有<PID,partition,SeqNumber> 作为唯一凭证，其中SeqNumber是顺序性的")])])])}),[],!1,null,null,null);e.default=a.exports},568:function(t,e,r){t.exports=r.p+"assets/img/producer4.076c01aa.png"},780:function(t,e,r){t.exports=r.p+"assets/img/order.841c1729.png"},781:function(t,e,r){t.exports=r.p+"assets/img/order2.ce3e164b.png"}}]);