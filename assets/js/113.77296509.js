(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{1052:function(s,a,t){"use strict";t.r(a);var n=t(15),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook")]),s._v(" "),n("p",[s._v("roles通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制")]),s._v(" "),n("p",[s._v("roles能够根据层次型结构自动装载变量文件、tasks以及handlers等，要使用roles只需要在playbook中使用include指令即可")]),s._v(" "),n("p",[s._v("roles一般用于基于主机构建服务的场景中，也可是用于构建守护进程等场景中")])]),s._v(" "),n("p",[s._v("使用场景")]),s._v(" "),n("ul",[n("li",[s._v("在复杂场景中，使用roles，代码复用度高")]),s._v(" "),n("li",[s._v("变更指定主机或主机组，如命名不规范维护和传承成本大")]),s._v(" "),n("li",[s._v("某些功能需多个Playbook，通过includes即可实现")])]),s._v(" "),n("h2",{attrs:{id:"roles目录结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#roles目录结构"}},[s._v("#")]),s._v(" roles目录结构")]),s._v(" "),n("p",[s._v("每个角色，以特定的层级目录结构进行组织")]),s._v(" "),n("img",{staticStyle:{zoom:"80%"},attrs:{src:t(961),alt:"image"}}),s._v(" "),n("p",[s._v("目录结构")]),s._v(" "),n("ul",[n("li",[s._v("playbook.yml（调用角色）")]),s._v(" "),n("li",[s._v("roles/ （官方推荐放在/etc/ansible/roles文件夹下）\n"),n("ul",[n("li",[s._v("role_name / （角色名称）\n"),n("ul",[n("li",[s._v("tasks/ （定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含）")]),s._v(" "),n("li",[s._v("files/  （存放由copy或script等模块调用的文件）")]),s._v(" "),n("li",[s._v("vars/ （定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含）")]),s._v(" "),n("li",[s._v("templates/ （template模块会自动在此目录中寻找Jinja2模板文件）")]),s._v(" "),n("li",[s._v("handlers/ （至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含）")]),s._v(" "),n("li",[s._v("default/（设定默认变量时使用此目录中的main.yml文件）")]),s._v(" "),n("li",[s._v("meta/（定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含）")])])])])])]),s._v(" "),n("h2",{attrs:{id:"应用实例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#应用实例"}},[s._v("#")]),s._v(" 应用实例")]),s._v(" "),n("p",[s._v("通过roles进行安装nginx，httpd，mysql，redis")]),s._v(" "),n("h3",{attrs:{id:"创建roles目录以及文件夹"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建roles目录以及文件夹"}},[s._v("#")]),s._v(" 创建roles目录以及文件夹")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir roles/{ngnix,httpd,mysql,redis}/tasks -pv")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir roles/httpd/{handlers,files}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tree /opt/")]),s._v("\nroles/\n├── httpd\n│   ├── files\n│   ├── handlers\n│   └── tasks\n├── mysql\n│   └── tasks\n├── nginx\n│   └── tasks\n└── redis\n    └── tasks\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"实现nginx的role执行逻辑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现nginx的role执行逻辑"}},[s._v("#")]),s._v(" 实现nginx的role执行逻辑")]),s._v(" "),n("p",[s._v("安装之前先查看是否已经安装过了nginx，如果有则卸载")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible all -m shell -a 'yum -y remove nginx'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看用户和用户组是否已创建，创建则需要删除")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible all -m shell -a 'getent passwd nginx'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible all -m shell -a 'getent group nginx'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果存在则删除创建的账号")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible all -m shell -a 'userdel -r nginx'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("在/opt/roles/nginx文件夹下创建tasks和templates文件夹")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/opt/roles/nginx\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\n总用量 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\ndrwxr-xr-x. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":45 tasks\ndrwxr-xr-x. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":55 templates\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h4",{attrs:{id:"创建nginx用户组task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建nginx用户组task"}},[s._v("#")]),s._v(" 创建nginx用户组task")]),s._v(" "),n("p",[s._v("在/opt/roles/nginx/tasks下创建group.yml文件，用于创建用户组，只需要填写task的name和指令即可")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat group.yml ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" create group\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("group")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=nginx gid=80\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"创建nignx用户task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建nignx用户task"}},[s._v("#")]),s._v(" 创建nignx用户task")]),s._v(" "),n("p",[s._v("在/opt/roles/nginx/tasks下创建group.yml文件，用于创建用户，只需要填写task的name和指令即可\n一般nginx的账户是系统账户，使用相同的uid以及gid，防止在不同的服务器创建user时使用不同的uid")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat user.yml ")]),s._v("\n- name: create user\n  user: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("group")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("system")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("shell")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/nologin\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"创建安装nginx的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建安装nginx的task"}},[s._v("#")]),s._v(" 创建安装nginx的task")]),s._v(" "),n("p",[s._v("在/opt/roles/nginx/tasks下创建yum.yml文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat yum.yml ")]),s._v("\n- name: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" package\n  yum: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"创建启动nginx的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建启动nginx的task"}},[s._v("#")]),s._v(" 创建启动nginx的task")]),s._v(" "),n("p",[s._v("在/opt/roles/nginx/tasks下创建start.yml文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat start.yml ")]),s._v("\n- name: start "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n  service: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("started "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("enabled")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("在/opt/roles/nginx/tasks下创建restart.yml文件，用于重启服务")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat restart.yml ")]),s._v("\n- name: start "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n  service: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("restarted\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"添加nginx的templates文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#添加nginx的templates文件"}},[s._v("#")]),s._v(" 添加nginx的templates文件")]),s._v(" "),n("p",[s._v("拷贝nginx.conf文件作为j2文件到templates中")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /etc/nginx/nginx.conf /opt/roles/nginx/templates/nginx.conf.j2")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改nginx.conf.j2文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 templates"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat nginx.conf.j2 ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nuser nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nworker_processes "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" ansible_processor_vcpus+2  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nerror_log /var/log/nginx/error.log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\npid /run/nginx.pid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.")]),s._v("\ninclude /usr/share/nginx/modules/*.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h4",{attrs:{id:"创建调用nginx的template文件的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建调用nginx的template文件的task"}},[s._v("#")]),s._v(" 创建调用nginx的template文件的task")]),s._v(" "),n("p",[s._v("在/opt/roles/nginx/tasks下创建templ.yml文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat templ.yml ")]),s._v("\n- name: copy conf\n  template: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("src")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx.conf.j2 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dest")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/nginx/nginx.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"创建-task的main-yml文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建-task的main-yml文件"}},[s._v("#")]),s._v(" 创建 task的main.yml文件")]),s._v(" "),n("p",[s._v("用于组织task执行的顺序，创建/opt/roles/nginx/tasks/main.yml文件\n使用"),n("code",[s._v("include")]),s._v(" 关键字进行调用，书写顺序就是执行顺序")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat main.yml ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" group.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" yum.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" templ.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" start.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h4",{attrs:{id:"创建playbook执行yml文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建playbook执行yml文件"}},[s._v("#")]),s._v(" 创建playbook执行yml文件")]),s._v(" "),n("p",[s._v("要求和roles文件同级目录下，创建/opt/nginx_role.yml文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("- hosts: app\n  remote_user: root\n  \n  roles:\n    - role: nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"执行playbook"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#执行playbook"}},[s._v("#")]),s._v(" 执行playbook")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ansible-playbook nginx_role.yml")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("再次查看目录结构")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 opt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tree /opt/")]),s._v("\nnginx_role.yml\nroles/\n├── httpd\n│   ├── files\n│   ├── handlers\n│   └── tasks\n├── mysql\n│   └── tasks\n├── nginx\n│   ├── tasks\n│   │   ├── group.yml\n│   │   ├── main.yml\n│   │   ├── restart.yml\n│   │   ├── start.yml\n│   │   ├── templ.yml\n│   │   ├── user.yml\n│   │   └── yum.yml\n│   └── templates\n│       └── nginx.conf.j2\n└── redis\n    └── tasks\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("h3",{attrs:{id:"实现httpd的role执行逻辑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现httpd的role执行逻辑"}},[s._v("#")]),s._v(" 实现httpd的role执行逻辑")]),s._v(" "),n("p",[s._v("先检查之前是否安装过httpd，卸载与删除已有账号")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("ansible all -m shell -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yum -y remove httpd'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除对应的用户")]),s._v("\nansible all -m user -a "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name=apache state=absent'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"创建user的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建user的task"}},[s._v("#")]),s._v(" 创建user的task")]),s._v(" "),n("p",[s._v("在httpd/tasks目录下创建user.yml")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" create user\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=apache system=yes shell=/sbin/nologin\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h4",{attrs:{id:"创建install的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建install的task"}},[s._v("#")]),s._v(" 创建install的task")]),s._v(" "),n("p",[s._v("在httpd/tasks目录下创建install.yml")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("- name: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" httpd package\n  yum: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h4",{attrs:{id:"创建copy-config-file的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建copy-config-file的task"}},[s._v("#")]),s._v(" 创建copy config file的task")]),s._v(" "),n("p",[s._v("先cp配置文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 httpd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp /etc/httpd/conf/httpd.conf files/")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("在httpd/tasks目录下创建config.yml")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" config file\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("copy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" src=/etc/httpd/conf/httpd.conf dest=/etc/httpd/conf/ backup=yes\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notify")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" restart service httpd "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在handlers的main.yml中定义")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h4",{attrs:{id:"创建copy-index的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建copy-index的task"}},[s._v("#")]),s._v(" 创建copy index的task")]),s._v(" "),n("p",[s._v("创建一个flies/index.html网页")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("h"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" welcome to stt home "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("h"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("创建配置文件tasks/index.yml")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" index.html\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("copy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" src=index.html dest=/var/www/html \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h4",{attrs:{id:"创建start-service的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建start-service的task"}},[s._v("#")]),s._v(" 创建start service的task")]),s._v(" "),n("p",[s._v("在httpd/tasks目录下创建service.yml")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("- name: start "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" \n  service: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("started "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("enabled")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h4",{attrs:{id:"创建task的main-yml主控文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建task的main-yml主控文件"}},[s._v("#")]),s._v(" 创建task的main.yml主控文件")]),s._v(" "),n("p",[s._v("创建main.yml主控文件,调用以上单独的yml文件， main.yml定义了谁先执行谁后执行的顺序")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("- include: user.yml\n- include: install.yml\n- include: config.yml\n- include: index.yml\n- include: service.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"创建handlers的main-yml文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建handlers的main-yml文件"}},[s._v("#")]),s._v(" 创建handlers的main.yml文件")]),s._v(" "),n("p",[s._v("创建handlers/main.yml，用于重启服务时，notify使用")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" restart service httpd\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=restarted\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("在handlers文件夹中必须有一个main.yml文件，其他yaml文件可以通过include进行引用")]),s._v(" "),n("h4",{attrs:{id:"创建playbook执行yml文件-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建playbook执行yml文件-2"}},[s._v("#")]),s._v(" 创建playbook执行yml文件")]),s._v(" "),n("p",[s._v("创建httpd_role.yml")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("- hosts: app\n  remote_user: root \n\n  roles:       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#调用角色")]),s._v("\n    - role: httpd\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("查看目录结构")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("httpd_role.yml\nroles\n├── httpd\n    ├── files\n    │   ├── httpd.conf\n    │   └── index.html\n    ├── handlers\n    │   └── main.yml\n    └── tasks\n        ├── config.yml\n        ├── index.yml\n        ├── install.yml\n        ├── main.yml\n        └── service.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h4",{attrs:{id:"执行playbook-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#执行playbook-2"}},[s._v("#")]),s._v(" 执行playbook")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("ansible-playbook httpd_role.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"同时调用多个role执行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同时调用多个role执行"}},[s._v("#")]),s._v(" 同时调用多个role执行")]),s._v(" "),n("p",[s._v("编写multi_role.yml文件，执行httpd和nginx安装")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root \n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#调用角色")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"跨role调用task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#跨role调用task"}},[s._v("#")]),s._v(" 跨role调用task")]),s._v(" "),n("p",[s._v("如果一个role需要调用另一个role中的task，需要指定路径，如nginx的tasks/main.yml需要调用httpd的tasks/config.yml文件，")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@linux101 tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat main.yml ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" group.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" yum.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" templ.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" start.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("include")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" roles/httpd/tasks/config.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"给role添加tag并执行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#给role添加tag并执行"}},[s._v("#")]),s._v(" 给role添加tag并执行")]),s._v(" "),n("p",[s._v("可以对不同的role设置不同的tag，然后执行，需要使用字典格式，编辑multi_role.yml")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root \n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#调用角色")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'web'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'httpd'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'web'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nginx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("执行playbook")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("ansible-playbook -t web multi_role.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"给role执行添加条件判断执行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#给role执行添加条件判断执行"}},[s._v("#")]),s._v(" 给role执行添加条件判断执行")]),s._v(" "),n("p",[s._v("只有在特定的条件下执行")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root \n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'web'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'httpd'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("when")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ansible_distribution_major_version == '7'"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'web'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nginx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"在role中使用变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在role中使用变量"}},[s._v("#")]),s._v(" 在role中使用变量")]),s._v(" "),n("p",[s._v("在roles目录下创建vars文件夹，并创建main.yml文件，定义变量")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("groupname")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("可以在tasks内的yaml或者xx.j2模板文件中通过"),n("code",[s._v(s._s(s.username))]),s._v("调用")]),s._v(" "),n("p",[s._v("示例：在playbook的main.yml文件中声明变量")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webservers\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" common "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 普通调用，没有变量，可省略 role:")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" foo_app_instance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dir")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/web/htdocs/a.com'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 传入变量调用")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports},961:function(s,a,t){s.exports=t.p+"assets/img/roles.8f03b319.png"}}]);